update_cacerts() {
  # Update java cacerts file with SSL cert from given host:port
  local cacerts=/etc/ssl/certs/java/cacerts
  local storepass=changeit
  local sslhost=${1%%:*}
  local alias
  local sslport=${1##*:}
  local ans
  
  if [ $EUID != 0 ]; then
    echo "Must be root."
    return
  fi

  if [ $# != 1 ]; then
    update_cacerts usage
    return
  fi

  if [ "$1" = usage ]; then
    echo "Usage:"
    echo "update_cacerts server.example.com:port"
    echo "update_cacerts some-cert.pem"
    return
  fi

  echo "Warning: this will overwrite $cacerts without making a backup."
  read -p "OK to continue (y/n)? " ans
  [ "$ans" != y ] && return

  local cert_source

  if [ -f "$1" ]; then
    cert_source="cat \"$1\""
    alias=$(openssl x509 -in "$1" -noout -subject | perl -pe 's{.*?CN=(.*)}{$1}')
    echo alias="$alias."
  else
    [ -z "$sslhost" -o "$sslhost" = "$sslport" ] && {
      update_cacerts usage
      return
    }
    alias=$sslhost
    cert_source="echo | openssl s_client -showcerts -connect $sslhost:$sslport"
  fi

  keytool -keystore $cacerts -storepass "$storepass" -delete -alias "$alias"
  eval "$cert_source | keytool -keystore $cacerts -storepass \"$storepass\" -noprompt -alias \"$alias\" -importcert"
  keytool -keystore $cacerts -storepass "$storepass" -list -alias "$alias"
  echo "Restart tomcat for changes to take effect in tomcat."

}
# vim:filetype=sh
