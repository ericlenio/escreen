# vim:filetype=sh
# Reset a user's password. Usage:
# ld_reset_password [dbname:]auth_prov/username
ld_reset_password() { 
  local ctx_prov_auth=$1
  local default_ctx=lincdoc
  if [ "${ctx_prov_auth}" = "${ctx_prov_auth%%:*}" ]; then
    ctx_prov_auth=$default_ctx:$ctx_prov_auth
  fi
  local ctx=${ctx_prov_auth%%:*}
  local auth_prov=${ctx_prov_auth##*:}
  auth_prov=${auth_prov%%/*}
  local user=${ctx_prov_auth##*/}
  if [ -z "$ctx" -o -z "$user" -o -z "$auth_prov" ]; then
    echo "Usage: ld_reset_password [context:]auth_prov/username"
    return
  fi

  eval $(_esh_b getLdPasswordResetParams)
  if [ -z "$LD_PW_INIT_SALT" -o "$LD_PW_INIT_SALT" = undefined ]; then
    echo "Missing LD_PW_INIT_SALT, you may need to create LD_PW_INIT_SALT, LD_PW_SALT_SIZE, LD_PW_HASH_ALG, and LD_PW_DGST_ITERATIONS in .escreenrc"
    return
  fi

  local newpw newpw2
  read -s -p "New password: " newpw
  echo
  [ -z "$newpw" ] && return
  read -s -p "Same password again: " newpw2
  echo
  if [ "$newpw" != "$newpw2" ]; then
    echo "Passwords do not match."
    return
  fi

  echo "Generating password digest ..."
  local salt=$(openssl rand -base64 $LD_PW_SALT_SIZE)
  local digest=$( ( echo $salt | openssl enc -d -base64; echo -n "$LD_PW_INIT_SALT$newpw" ) | openssl enc -base64)
  for i in $(seq 1 $LD_PW_DGST_ITERATIONS); do
    digest=$(echo $digest | openssl enc -d -base64 | openssl dgst -$LD_PW_HASH_ALG -binary | openssl enc -base64)
  done
  digest=$( ( echo $salt | openssl enc -d -base64; echo $digest | openssl enc -d -base64 ) | openssl enc -base64)

  if [ ${#digest} = 0 ]; then
    echo "Oops: digest is 0 bytes, aborting."
    return
  fi

  local yesno
  echo "App context: $ctx"
  echo "Auth provider: $auth_prov"
  echo "Username: $user"
  read -p "Confirm: proceed to reset the password (y/n, default=n)? " yesno
  [ "$yesno" != y ] && return
  echo "If you see UPDATE 1, the password reset was successful."
  local psql="$(lwsa --get_psql_connect $ctx --silent)"
  eval "$psql" <<EOF
  update ld_admin.ld_dbp_user set cryptpw='$digest' where provider_id='$auth_prov' and username='$user';
EOF

}
