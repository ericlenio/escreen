# vim:filetype=bash
#
# logic to execute with bash's PROMPT_COMMAND
#
-prompt() {
  if [ -z "$(trap -p)" ]; then
    trap _esh_trap_EXIT EXIT
    trap _esh_trap_HUP HUP
  fi

  if [ -z "$ESH_TERM_AUTH_TOKEN" ]; then
    _esh_at force_new_at
    if [ "$ESH_ATSERVER_PID" ]; then
      # implies we are inside gnu screen
      curl -d STY=$STY -H "X-Escreen-Auth: $ESH_TERM_AUTH_TOKEN" -H "X-Escreen-User: $USER" $ESH_ATSERVER_URL/set-sty
      ESH_CURRENT_STY=$STY
      _esh_e +ESH_CURRENT_STY
    fi
  fi

  # use DEBUG trap to load environment vars from _esh_e before every command is
  # run; only set the trap if we detect DEBUG has no signal handler yet
  #
  # 09/17/2020 taking out this DEBUG trap, it's an abuse of DEBUG and is
  # causing other conflicts, e.g.
  # https://superuser.com/questions/1084406/chained-pipes-in-bash-throws-operation-not-permitted
  #
  #if [ -z "$(trap -p DEBUG)" ]; then
    # TO DO: do some sort of sanity checking that _esh_e contains only
    # "declare" statements
    #trap 'eval "$(_esh_e)"' DEBUG
    # set shell option so that the DEBUG trap is executed in subshells
    #set -T
  #fi

  if [[ "$BASHOPTS" =~ expand_aliases ]]; then
    # disable all aliases, sometimes they conflict with bash functions of the
    # same name (in particular, often have "alias l='ls -CF'" in $HOME/.bashrc);
    #
    # each new window in gnu screen will always source $HOME/.bashrc, this is
    # why we put this logic to run in PROMPT_COMMAND and not _esh_i
    shopt -u expand_aliases
    unalias -a
  fi

  if [ -z "$RA_USER_PASSWORD_64" ]; then
    read RA_USER_PASSWORD_64 < <(_esh_y _ra_get_ldap_pw)
  fi

  # 
  # if not inside GNU screen, check that we have a shell EXIT handler to erase
  # ESH_TERM_AUTH_TOKEN from all used GNU screen sessions
  #
  #if [ -z "$STY" -a -z "$(trap -p EXIT)" ]; then
  #  _esh_exit() {
  #    if [ "$ESH_STY" ]; then
  #      # erase ESH_TERM_AUTH_TOKEN from screen session register
  #      env screen -S $ESH_STY -X register p "" >/dev/null 2>&1
  #    fi
  #  }
  #  trap _esh_exit EXIT
  #fi

  # work around ubuntu hardcoding PS1
  PS1="$ESH_PS1"
}
export -f -- -prompt
