# vim:filetype=sh
#
# _ES_bootstrap bootstraps a function
#
function _ES_bootstrap() {
  local pwmarker="$(_ES_marker GET_SCRIPT_PW)"
  local upmarker="$(_ES_marker UPLOAD_SCRIPT)"
  local funcname=$1
  local f=$_ES_FCN_PREFIX$funcname
  local s l fname pw script
  if [ -f $f ]; then
    if s="$(_ES_send_marker $pwmarker $funcname | openssl enc -d -a -aes256 -in $f -pass stdin | gzip -d -c)"; then
      eval "$s" && _ES_set_loaded $funcname && "$@"
      return
    fi
    # fall through to below, re-upload and cache the script
  fi
  [ ! -f $f ] && touch $f && chmod 666 $f
  # cache the function
  _ES_send_marker "$upmarker" $funcname > $f
  # call ourself again, this time it should decrypt above
  _ES_bootstrap "$@"
}
export -f _ES_bootstrap
