# vim:filetype=sh
# copy_to_clipboard: use perl to remove the last \n on the last line (because
# vim's writefile will always put an extra one), and minimally set a hyphen
# character in the stream so as to not pass 0 bytes to clipit (which causes it
# to block)
function copy_to_clipboard() {
  local marker=$(_ES_marker COPY_TO_CLIPBOARD)
  local f="$1"
  if [ -z "$f" ]; then
    f="-"
  elif [ ! -e "$f" ]; then
    echo "Error: no such file, or file is not readable: $f"
    f=/dev/null
  fi
  local c=$(perl -pe 'chomp if eof' -- "$f")
  [ -z "$c" ] && c="-"
  _ES_send_marker "$marker" "$c"
  # This read acts as a block so if on a slower connection it gives the handler
  # enough time to write out a status line. The handler will send the status
  # line in this read, and we just let it go to stderr so user sees it.
  read >&2 </dev/tty
}
export -f copy_to_clipboard
