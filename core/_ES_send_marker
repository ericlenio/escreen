# vim:filetype=sh
#
# Display a marker that expect-ssh picks up on and run the marker's
# corresponding event handler.
#
function _ES_send_marker() {
  local l
  {
    echo "$1"
    # if stdin is a terminal, use the 2nd arg to this function as the parameter
    # string for the event handler; else stdin itself is the event handler
    # parameter string
    #{ [ -t 0 ] && printf "$2" || cat -; } | gzip -9 -c | openssl enc -base64 | {
    printf "$2" | gzip -9 -c | openssl enc -base64 | {
      while IFS=$'\n' read -r l || [ -n "$l" ]; do
        printf "%s\n" $l
      done
    }
    echo .
  } | nc localhost $EXPECTSSH_PORT
}
export -f _ES_send_marker
