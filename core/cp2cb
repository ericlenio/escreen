# vim:filetype=sh
# cp2cb: use perl to remove the last \n on the last line (because vim's
# writefile will always put an extra one).
cp2cb() {
  local f="$1"
  if [ -t 0 ]; then
    if [ ! -e "$f" ]; then
      echo "Error: no such file, or file is not readable: $f"
      return 1
    fi
  else
    f="-"
  fi
  # override ESH_NC to not use "-q -1": we want nc to close as soon as it has
  # read all of its stdin
  local nc=${ESH_NC/-q -1/-q 0}
  [ `uname -s` = FreeBSD ] && nc="nc -N"
  perl -pe 'chomp if eof' -- "$f" | gzip -9 -c | ESH_NC="$nc" _esh_b setCb
}
export -f cp2cb
