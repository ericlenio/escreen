# vim:filetype=sh
#
# Wrapper for sudo. Usage examples:
# To become root:
#   s
# To become nobody
#   s nobody
# To become lincdoc and edit /etc/services:
#   s lincdoc vim /etc/services
function s() {
  local user
  if [ $# -eq 0 ]; then
    user=root
  else
    user=$1
    shift
  fi

  id -u "$user" >/dev/null 2>&1 || {
    echo "No such user \"$user\"."
    return
  }

  local cmd=("$@")
  [ $# -eq 0 ] && cmd=(exec /bin/bash --norc --noprofile)

  local c='true
eval "$(openssl enc -d -base64 << EOF
'"$(declare -f _ES_core|openssl enc -base64)"'
EOF
)"
export -f _ES_core
# _ES_core will generate stub functions, so important to run this first and the
# override those stubs with already loaded functions below.
_ES_core

eval "$(openssl enc -d -base64 << EOF
'"$(declare -f $EXPECTSSH_LOADED_FUNCS|openssl enc -base64)"'
EOF
)"

export EXPECTSSH_LOADED_FUNCS='"$EXPECTSSH_LOADED_FUNCS"'
export -f '"$EXPECTSSH_LOADED_FUNCS"'
"$@" </dev/tty'

  echo "$c"|sudo -H -u $user -- /bin/bash -s "${cmd[@]}"
}
