#! /usr/bin/env bash
ESH_HOME=$(node -r fs -e "console.log(fs.realpathSync(fs.realpathSync('$0')+'/..'))")
escreen_branch=$(cd $ESH_HOME && git rev-parse --abbrev-ref HEAD)
suffix=-$escreen_branch
[ $escreen_branch = master ] && suffix=""
ESH_TMP=/tmp/esh$suffix
[ ! -d $ESH_TMP ] && mkdir $ESH_TMP && chmod 1777 $ESH_TMP
ESH_USER=$USER
ESH_AT=xxxxx1
ESH_PORT=2021

# only allow these environment variables to pass to the server process
pass_vars=(HOME PATH SSH_AUTH_SOCK ESH_HOME ESH_TMP ESH_USER ESH_AT ESH_PORT LANG)
# OpenBSD (and possibly Linux) depend on $DISPLAY for clipboard logic, so pass
# it too if it is set
[ "$DISPLAY" ] && pass_vars+=($DISPLAY)

exec=(env -i)
for var in ${pass_vars[@]}; do
  exec+=($var="${!var}")
done
exec+=($(which node) $ESH_HOME/server.js)

exec "${exec[@]}"
