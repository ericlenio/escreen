# vim:filetype=expect
_ES_register_marker VIM_PASTE_CLIPBOARD paste_from_clipboard_in_vim

proc paste_from_clipboard_in_vim {} {
  global OS PROMPT ANSI_RE_SHOW_CURSOR
  send ":shell\r"
  expect -re $PROMPT
  # encode the clipboard data and send it across the wire, decoding it on the
  # other end, and store it in the VIM_CLIPBOARD file. Leading space before
  # commands so as to not save them to history
  send " exec 3> >(/usr/bin/openssl enc -base64 -d | gzip -d -c > \$VIM_CLIPBOARD)\r"
  send { while true; do read -d' ' l; [ "$l" = . ] && break; printf "%s\n" $l >&3; printf "\015"; done; exec 3>&-}
  send \r
  expect -re \r\n$
  if { "$OS" == "Linux" } {
    set buf [exec clipit -c | gzip -9 -c | /usr/bin/openssl enc -base64]
  } elseif { "$OS" == "Darwin" } {
    set buf [exec pbpaste | gzip -9 -c | /usr/bin/openssl enc -base64]
  }
  foreach line [split $buf] {
    send "[string trimright $line] "
    expect {
      -re "\x0d$" {}
      timeout { send_error "TIMEOUT in paste_from_clipboard_in_vim"; return }
    }
  }
  send ". "
  expect ". "
  expect -re $PROMPT
  send " exit\r"
  expect {
    -re $ANSI_RE_SHOW_CURSOR {
      # read the file and put it in the unnamed register
      send {:let @"=join(readfile($VIM_CLIPBOARD,"b"),"\n")}
      send "\r"
      expect {
        -re $ANSI_RE_SHOW_CURSOR {
          # paste contents of unnamed register
          send ":if col(\"\$\")-col(\".\")==1 | call feedkeys(\"p\") | else | call feedkeys(\"P\") | endif\r"
        }
        -re {has changed since editing started.*\(L\)oad File: $} {}
        timeout {send_error "TIMEOUT #1 during paste, aborting"; return}
      }
    }
    -re {has changed since editing started.*\(L\)oad File: $} {}
    timeout {send_error "TIMEOUT #2 during paste, aborting"; return}
  }
}
